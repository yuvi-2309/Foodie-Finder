<div class="restaurant-detail-container">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading restaurant details...</p>
    </div>
  } @else if (restaurant()) {
    <button mat-icon-button class="back-button" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <div class="restaurant-header">
      <div class="header-image" [style.background-image]="'url(' + (restaurant()!.imageUrl || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800') + ')'">
        <div class="header-gradient"></div>
      </div>

      <div class="header-content">
        <div class="title-section">
          <h1>{{ restaurant()!.name }}</h1>
          @if (restaurant()!.priceRange !== undefined) {
            <div class="price-badge">{{ getPriceRange(restaurant()!.priceRange!) }}</div>
          }
        </div>

        @if (restaurant()!.cuisine) {
          <mat-chip-set class="cuisine-chip">
            <mat-chip>{{ restaurant()!.cuisine }}</mat-chip>
          </mat-chip-set>
        }

        @if (restaurant()!.totalReviews !== undefined && restaurant()!.totalReviews! > 0) {
          <div class="rating-section">
            <div class="rating-big">{{ restaurant()!.averageRating || 0 | number: '1.1-1' }}</div>
            <div class="rating-details">
              <div class="stars">
                @for (star of getStarArray(restaurant()!.averageRating || 0); track $index) {
                  <mat-icon [class.filled]="star === 1">star</mat-icon>
                }
              </div>
              <span class="rating-text">
                Based on {{ restaurant()!.totalReviews }} review{{ restaurant()!.totalReviews! > 1 ? 's' : '' }}
              </span>
            </div>
          </div>
        }

        @if (restaurant()!.description) {
          <p class="description">{{ restaurant()!.description }}</p>
        }
      </div>
    </div>

    <mat-card class="info-card">
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <mat-icon>location_on</mat-icon>
            <div>
              <strong>Address</strong>
              <p>{{ restaurant()!.address || restaurant()!.location || 'Not available' }}</p>
            </div>
          </div>

          @if (restaurant()!.phone) {
            <div class="info-item">
              <mat-icon>phone</mat-icon>
              <div>
                <strong>Phone</strong>
                <p>{{ restaurant()!.phone }}</p>
              </div>
            </div>
          }

          @if (restaurant()!.website) {
            <div class="info-item">
              <mat-icon>language</mat-icon>
              <div>
                <strong>Website</strong>
                <p><a [href]="'https://' + restaurant()!.website" target="_blank">{{ restaurant()!.website }}</a></p>
              </div>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Photo Gallery -->
    @if (reviewPhotos().length > 0) {
      <div class="photo-gallery-section">
        <h2>
          <mat-icon>photo_library</mat-icon>
          Photos from Reviews
        </h2>
        <div class="photo-grid">
          @for (photo of reviewPhotos(); track photo) {
            <div class="photo-thumb" (click)="openPhoto(photo)">
              <img [src]="photo" alt="Review photo" />
              <div class="photo-overlay">
                <mat-icon>zoom_in</mat-icon>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Photo Lightbox -->
    @if (selectedPhoto()) {
      <div class="photo-lightbox" (click)="closePhoto()">
        <button mat-icon-button class="close-lightbox" (click)="closePhoto()">
          <mat-icon>close</mat-icon>
        </button>
        <img [src]="selectedPhoto()" alt="Review photo enlarged" />
      </div>
    }

    <div class="reviews-section">
      <div class="reviews-header">
        <h2>Reviews ({{ reviews().length }})</h2>
        <button mat-raised-button color="primary" class="write-review-btn" (click)="toggleReviewForm()">
          <mat-icon>rate_review</mat-icon>
          {{ showReviewForm() ? 'Cancel' : 'Write a Review' }}
        </button>
      </div>

      @if (showReviewForm()) {
        <app-review-form
          [restaurantId]="restaurantId()"
          (reviewSubmitted)="onReviewSubmitted($event)"
        ></app-review-form>
      }

      <mat-divider></mat-divider>

      @if (reviews().length === 0) {
        <div class="no-reviews">
          <mat-icon>rate_review</mat-icon>
          <h3>No reviews yet</h3>
          <p>Be the first to share your experience!</p>
        </div>
      } @else {
        <div class="reviews-list">
          @for (review of reviews(); track review.id) {
            <mat-card class="review-card">
              <mat-card-header>
                <div class="review-header-content">
                  <div class="user-info">
                    <div class="avatar">
                      <mat-icon>account_circle</mat-icon>
                    </div>
                    <div>
                      <strong>{{ review.username || review.user_id.substring(0, 8) || 'Anonymous' }}</strong>
                      @if (review.created_at || review.createdAt) {
                        <p class="review-date">{{ formatDate(review.created_at || review.createdAt) }}</p>
                      }
                    </div>
                  </div>

                  <div class="review-rating">
                    <div class="stars small">
                      @for (star of getStarArray(review.rating); track $index) {
                        <mat-icon [class.filled]="star === 1">star</mat-icon>
                      }
                    </div>
                  </div>
                </div>
              </mat-card-header>

              <mat-card-content>
                <p class="review-text">{{ review.content }}</p>

                @if (review.photo_url) {
                  <div class="review-photo" (click)="openPhoto(review.photo_url)">
                    <img [src]="review.photo_url" alt="Review photo" />
                  </div>
                }
              </mat-card-content>

              @if (review.user_id === authService.currentUser()?.id) {
                <mat-card-actions>
                  <button mat-button color="warn" (click)="deleteReview(review)">
                    <mat-icon>delete</mat-icon>
                    Delete
                  </button>
                </mat-card-actions>
              }
            </mat-card>
          }
        </div>
      }
    </div>
  }
</div>
