<div class="detail-page">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading restaurant...</p>
    </div>
  } @else if (restaurant()) {
    <!-- Compact Hero Banner -->
    <div class="hero-banner">
      <div class="hero-image" [style.background-image]="'url(' + (restaurant()!.imageUrl || getRestaurantImage(restaurant()!.name)) + ')'">
        <div class="hero-overlay"></div>
      </div>
      <button mat-icon-button class="back-btn" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="hero-content">
        <div class="hero-meta">
          @if (restaurant()!.cuisine) {
            <span class="cuisine-tag">{{ restaurant()!.cuisine }}</span>
          }
          @if (restaurant()!.priceRange !== undefined) {
            <span class="price-tag">{{ getPriceRange(restaurant()!.priceRange!) }}</span>
          }
        </div>
        <h1>{{ restaurant()!.name }}</h1>
        @if (restaurant()!.totalReviews !== undefined && restaurant()!.totalReviews! > 0) {
          <div class="hero-rating">
            <div class="stars">
              @for (star of getStarArray(restaurant()!.averageRating || 0); track $index) {
                <mat-icon [class.filled]="star === 1">star</mat-icon>
              }
            </div>
            <span class="rating-value">{{ restaurant()!.averageRating || 0 | number: '1.1-1' }}</span>
            <span class="rating-count">({{ restaurant()!.totalReviews }})</span>
          </div>
        }
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-area">
      <!-- About -->
      @if (restaurant()!.description) {
        <section class="about-section">
          <h3>About</h3>
          <p>{{ restaurant()!.description }}</p>
        </section>
      }

      <!-- Details Bar -->
      <div class="details-bar">
        <div class="info-row">
          <mat-icon>location_on</mat-icon>
          <span>{{ restaurant()!.address || restaurant()!.location || 'Not available' }}</span>
        </div>
        @if (restaurant()!.phone) {
          <div class="info-row">
            <mat-icon>phone</mat-icon>
            <span>{{ restaurant()!.phone }}</span>
          </div>
        }
        @if (restaurant()!.website) {
          <div class="info-row">
            <mat-icon>language</mat-icon>
            <a [href]="'https://' + restaurant()!.website" target="_blank">{{ restaurant()!.website }}</a>
          </div>
        }
      </div>

      <!-- Photo Gallery -->
      @if (reviewPhotos().length > 0) {
        <section class="gallery-section">
          <h3><mat-icon>photo_library</mat-icon> Photos</h3>
          <div class="photo-strip">
            @for (photo of reviewPhotos(); track photo) {
              <div class="photo-thumb" (click)="openPhoto(photo)">
                <img [src]="photo" alt="Review photo" />
                <div class="photo-hover"><mat-icon>zoom_in</mat-icon></div>
              </div>
            }
          </div>
        </section>
      }

      <!-- Reviews -->
      <section class="reviews-section">
        <div class="reviews-bar">
          <h3>Reviews <span class="count">({{ reviews().length }})</span></h3>
          <button mat-flat-button color="primary" class="review-btn" (click)="toggleReviewForm()">
            <mat-icon>{{ showReviewForm() ? 'close' : 'edit' }}</mat-icon>
            {{ showReviewForm() ? 'Cancel' : 'Write Review' }}
          </button>
        </div>

        @if (showReviewForm()) {
          <app-review-form
            [restaurantId]="restaurantId()"
            (reviewSubmitted)="onReviewSubmitted($event)"
          ></app-review-form>
        }

        @if (reviews().length === 0) {
          <div class="empty-reviews">
            <mat-icon>chat_bubble_outline</mat-icon>
            <p>No reviews yet â€” be the first!</p>
          </div>
        } @else {
          <div class="reviews-list">
            @for (review of reviews(); track review.id) {
              <div class="review-item">
                <div class="review-top">
                  <div class="reviewer">
                    <div class="reviewer-avatar">
                      {{ (review.username || review.user_id || '?').charAt(0).toUpperCase() }}
                    </div>
                    <div class="reviewer-info">
                      <span class="reviewer-name">{{ review.username || review.user_id.substring(0, 8) || 'Anonymous' }}</span>
                      @if (review.created_at || review.createdAt) {
                        <span class="review-date">{{ formatDate(review.created_at || review.createdAt) }}</span>
                      }
                    </div>
                  </div>
                  <div class="stars compact">
                    @for (star of getStarArray(review.rating); track $index) {
                      <mat-icon [class.filled]="star === 1">star</mat-icon>
                    }
                  </div>
                </div>

                <p class="review-body">{{ review.content }}</p>

                @if (review.photo_url) {
                  <img class="review-img" [src]="review.photo_url" alt="Review photo" (click)="openPhoto(review.photo_url)" />
                }

                @if (review.user_id === authService.currentUser()?.id) {
                  <button mat-button color="warn" class="delete-btn" (click)="deleteReview(review)">
                    <mat-icon>delete_outline</mat-icon> Delete
                  </button>
                }
              </div>
            }
          </div>
        }
      </section>
    </div>

    <!-- Lightbox -->
    @if (selectedPhoto()) {
      <div class="lightbox" (click)="closePhoto()">
        <button mat-icon-button class="lightbox-close" (click)="closePhoto()">
          <mat-icon>close</mat-icon>
        </button>
        <img [src]="selectedPhoto()" alt="Photo enlarged" />
      </div>
    }
  }
</div>
